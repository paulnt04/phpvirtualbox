<!-- 

	Main / Top menu
	Copyright (C) 2011 Ian Moore (imoore76 at yahoo dot com)

	$Id$

 -->
<script type='text/javascript'>
/*
 * 
 * Main menu at top of interface
 * 
 * 
 */

// Top menu
var topMenu = new vboxMenuBar('vboxTop');

var menu = {
	'name':'vboxTopFile',
	'title':'File',
	'menu':[
        {
			'name':'fileVMM',
			'title':'Virtual Media Manager',
			'icon':'diskimage',
			'click':function(){vboxVMMDialogInit();}
        },
        {
			'name':'fileImport',
			'title':'Import Appliance',
			'icon':'import',
			'click':function(){vboxImportApplianceDialogInit();},
			'separator': true
        },
        {
			'name':'fileExport',
			'title':'Export Appliance',
			'icon':'export',
			'click':function(){vboxExportApplianceDialogInit();}
        },
        {
			'name':'filePrefs',
			'title':'Preferences',
			'icon':'global_settings',
			'click':function(){vboxPrefsInit();},
			'separator':true
        }
	]
};

if($('#vboxIndex').data('vboxSession').user) {
	menu['menu'][menu['menu'].length] = {
		'name' : 'fileChangePW',
		'title' : 'Change Password',
		'icon' : 'register',
		'click': function() {
			var l = new vboxLoader();
			l.addFile('panes/userEdit.html',function(f){$('#vboxIndex').append(f);});
			l.onLoad = function(){
				
				// Set mode
				$('#vboxUserEdit').trigger('setMode','changePassword');
				
				var buttons = {};
				buttons[trans('OK')] = function() {
					var o = $('#vboxUserEdit').find('input[name=opass]').first().val();
					var n1 = $('#vboxUserEdit').find('input[name=npass1]').first().val();
					var n2 = $('#vboxUserEdit').find('input[name=npass2]').first().val();
					if(o.length == 0) {
						vboxAlert(trans('The password you have entered is invalid.'),{'width':'auto'});
						return;
					}
					if(n1.length == 0 || (n1 != n2)) {
						vboxAlert(trans('The passwords you have entered do not match.'),{'width':'auto'});
						return;
					}
					var dialog = this;
					var chp = new vboxLoader();
					chp.mode = 'save';
					chp.add('changePassword',function(d){
						if(d) {
							if(d.result) {
								vboxAlert(trans('Password changed.'),{'width':'auto'});
								$(dialog).remove();
							} else {
								vboxAlert(trans('The password you have entered is invalid.'),{'width':'auto'});
							}
						} else {
							// unknown error
							$(dialog).remove();
						}
					},{'old':o,'new':n1});
					chp.run();
				}
				buttons[trans('Cancel')] = function(){
					$(this).remove();
				}
				$('#vboxUserEdit').dialog({'closeOnEscape':false,'width':400,'height':200,'buttons':buttons,'modal':true,'autoOpen':true,'stack':true,'dialogClass':'vboxDialogContent','title':'<img src="images/vbox/register_16px.png" class="vboxDialogTitleIcon" /> '+trans('Change Password')});
			}
			l.run();			
		},
		'separator':true
	};
	menu['menu'][menu['menu'].length] = {
			'name' : 'fileLogout',
			// Pre-translated title to append username
			'title' : trans('Log out') + ' - ' + $('#vboxIndex').data('vboxSession').user,
			'icon' : 'exit',
			'click': function() {
				var l = new vboxLoader();
				l.add('logout',function(){
					location.reload(true);
				});
				l.onLoad = function(){
					this.hideRoot = false;
				}
				l.mode = 'save';
				l.hideRoot = true;
				l.run();				
			}
		};
	
}
	
topMenu.addMenu(menu);

var menu = {
	'name':'vboxTopMachine',
	'title':'Machine',
	'menu':[
        {
			'name':'machineNew',
			'title':'New',
			'icon':'new',
			'click':function(){vboxWizardNewVMInit(function(){return;})}
        },
        {
			'name':'machineAdd',
			'title':'Add',
			'icon':'vm_add',
			'click':function(){
				vboxFileBrowser($('#vboxIndex').data('vboxSystemProperties').defaultMachineFolder,function(f){
					if(!f) return;
					var l = new vboxLoader();
					l.mode = 'save';
					l.add('addVM',function(){},{'file':f});
					l.onLoad = function(){
						var lm = new vboxLoader();
						lm.add('Mediums',function(d){$('#vboxIndex').data('vboxMediums',d);});
						lm.onLoad = function() {$('#vboxIndex').trigger('vmlistreload');}
						lm.run();
					}
					l.run();
					
				},false);
			}
        },        
        {
			'name':'machineSettings',
			'title':'Settings',
			'icon':'settings',
			'click':function(){
				vboxVMsettingsInit($('#vboxIndex').data('selectedVM').id,function(){
					$('#vboxIndex').trigger('vmselect',[$('#vboxIndex').data('selectedVM')]);
				});
			},
			'enabled':function(vm){ return vm && (vm.state == 'PoweredOff' || vm.state == 'Aborted'); }
        },
        {
			'name':'machineRefresh',
			'title':'Refresh',
			'icon':'refresh',
			'icon_disabled':'refresh_disabled',
			'click':function(){
				var l = new vboxLoader();
				l.add('VMDetails',function(d){
					// Special case for host refresh
					if(d.id == 'host') {
						$('#vboxIndex').data('vboxHostDetails',d);
					}
					$('#vboxIndex').trigger('vmselect',[$('#vboxIndex').data('selectedVM')]);
				},{'vm':$('#vboxIndex').data('selectedVM').id,'force_refresh':1});
				
				// Host refresh also refreshes system properties
				if($('#vboxIndex').data('selectedVM').id == 'host') {
					l.add('SystemProperties',function(d){$('#vboxIndex').data('vboxSystemProperties',d);},{'force_refresh':1});
				}
				l.run();
        	},
			'enabled':function(vm){ return vm; }
        },
        {
			'name':'machineDelete',
			'title':'Remove',
			'icon':'delete',
			'click':function(){

				var buttons = {};

				/* Unregister Inaccessible or Delete? */
				if($('#vboxIndex').data('selectedVM').state == 'Inaccessible') {
					
					buttons[trans('Unregister')] = function(){
						$(this).empty().remove();
						var l = new vboxLoader();
						l.add('removeVM',function(){},{'vm':$('#vboxIndex').data('selectedVM').id,'unregister':1});
						l.mode = 'save';
						l.onLoad = function(){$('#vboxIndex').trigger('vmlistreload');};
						l.run();
					}
					var q = trans('Unregister VM Message1').replace('%s','<b>'+$('#vboxIndex').data('selectedVM').name+'</b>') + '<p>'+trans('Unregister VM Message2')+'</p>';
					
				} else {
					buttons[trans('Delete all files')] = function(){
						$(this).empty().remove();
						vboxAjaxRequest('removeVM',{'vm':$('#vboxIndex').data('selectedVM').id,'delete':1},function(d){
							// check for progress operation
							if(d && d.progress) {
								vboxProgress(d.progress,function(){$('#vboxIndex').trigger('vmlistreload');},{},'progress_delete_90px.png');
								return;
							}
							$('#vboxIndex').trigger('vmlistreload');
						});
					}
					buttons[trans('Remove only')] = function(){
						$(this).empty().remove();
						vboxAjaxRequest('removeVM',{'vm':$('#vboxIndex').data('selectedVM').id,'keep':1},function(d){
							// check for progress operation
							if(d && d.progress) {
								vboxProgress(d.progress,function(){$('#vboxIndex').trigger('vmlistreload');});
								return;
							}
							$('#vboxIndex').trigger('vmlistreload');
						});
					}
					
					var q = trans('Delete VM Message1').replace('%s','<b>'+$('#vboxIndex').data('selectedVM').name+'</b>') + '<p>'+trans('Delete VM Message2')+'</p>';
				}				
				vboxConfirm(q,buttons);
        	
        	},
			'enabled':function(vm){ return vm && (vm.state == 'PoweredOff' || vm.state == 'Aborted' || vm.state == 'Inaccessible'); },
			'separator':true
        },
        {
			'name':'machineDiscard',
			'title':'Discard',
			'icon':'discard',
			'click':function(){
				var buttons = {};
				buttons[trans('Discard')] = function(){
					$(this).empty().remove();
					var l = new vboxLoader();
					l.add('setStateVMdiscardSavedState',function(){},{'vm':$('#vboxIndex').data('selectedVM').id});
					l.mode = 'save';
					l.onLoad = function(){$('#vboxIndex').trigger('vmlistrefresh');};
					l.run();
				}
				vboxConfirm(trans('Discard Message1').replace('%s','<b>'+$('#vboxIndex').data('selectedVM').name+'</b>') + '<p><b>'+trans('Discard Message2')+'</b></p>',buttons);
			},
			'enabled':function(vm){ return (vm && vm.state == 'Saved'); }
        },
        {
			'name':'machineLogs',
			'title':'Show Log',
			'icon':'show_logs',
			'icon_disabled':'show_logs_disabled',
			'click':function(){
        		vboxShowLogsDialogInit($('#vboxIndex').data('selectedVM').id);
			},
			'enabled':function(vm){ return (vm && vm.id && vm.id != 'host'); },
			'separator':true
        }
        
	]
};
	
topMenu.addMenu(menu);

var menu = {
	'name':'vboxTopHelp',
	'title':'Help',
	'menu':[
        {
			'name':'helpvbox',
			'title':'VirtualBox User Manual',
			'icon':'images/vbox/site_16px.png',
			'icon_absolute':true,
			'click':function(){
				window.open('http://www.virtualbox.org/manual/','manual');        	
        	}
        },
        
        {
			'name':'helpAbout',
			'title':'About',
			'icon':'help',
			'click':function(){
        	
	        	var div = document.createElement('div');
	        	div.setAttribute('id','vboxAbout');
	        	div.setAttribute('class','vboxDialogContent');
	        	div.setAttribute('style','display: none; width: 500px;');
	        	$('#vboxIndex').append(div);
	
	        	var l = new vboxLoader();
	        	l.addFile('panes/about.html',function(f){$('#vboxAbout').append(f);});
	        	l.onLoad = function() {
		        	var buttons = {};
		        	buttons[trans('OK')] = function() { $(this).empty().remove(); };
		
		            $('#vboxAbout').dialog({'closeOnEscape':false,'width':500,'height':'auto','buttons':buttons,'modal':true,'autoOpen':true,'stack':true,'dialogClass':'vboxDialogContent','title':'<img src="images/vbox/help_16px.png" class="vboxDialogTitleIcon" /> phpVirtualBox'});			        	
	        	}
	        	l.run();
        	}
        }
        
    ]
};
topMenu.addMenu(menu);

topMenu.addMenuBar('vboxMenu');
$('#vboxIndex').bind('vmselect',topMenu.update);

	
</script>