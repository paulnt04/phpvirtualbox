<!-- $Id$
Copyright (C) 2011 Ian Moore (imoore76 at yahoo dot com)
-->
<div id='vboxMount' style='margin:0px;'>
	<div id='vboxMountController'></div>
	<div id='vboxMountDivMain'>
		<table style='margin: 0px; width: 100%;' id='vboxMountTblMain'>
			<tr style='vertical-align: middle'>
				<td style='width: 90%;'>
					<div id='vboxMountDriveSlot'></div>
				</td>
				<td id='vboxMountToolbar'>
					
				</td>
			</tr>
			<tr style='vertical-align: middle;'>
				<td style='text-align: center;' id='vboxMountMediumLabel'>
				</td>
				<td style='text-align: left; padding: 0px; margin: 0px;'>
					<div style='background: #f55; display: inline-block; height: 4px; width: 4px;border:1px solid #000;'></div>
					<div style='background: #9f9; display: inline-block; height: 4px; width: 4px;border:1px solid #0f0;'></div>
				</td>
			</tr>
		</table>
	</div>
<script type='text/javascript'>

var sButtonCD = {
	/* Add Attachment Button */
	'name' : 'mselectcdbtn',
	'label' : 'Set up the virtual CD/DVD drive',
	'icon' : 'cd',
	'click' : function () {
		return;				
	}
};

var sButtonFD = {
	/* Add Attachment Button */
	'name' : 'mselectfdbtn',
	'label' : 'Set up the virtual floppy drive',
	'icon' : 'fd',
	'click' : function () {
		return;				
	}
};

var storage = new vboxStorage();

function vboxMountPostInit(bus,port,device) {
	
	
	var vm = $('#vboxMountDialog').data('vboxMachineData');
	var busName = null;
	var type = null;
	var medium = null;
	
	for(var i = 0; i < vm.storageControllers.length; i++) {
		if(vm.storageControllers[i].bus == bus) {
			busName = vm.storageControllers[i].name;
			for(var a = 0; a < vm.storageControllers[i].mediumAttachments.length; a++) {
				if(vm.storageControllers[i].mediumAttachments[a].port == port && vm.storageControllers[i].mediumAttachments[a].device == device) {
					type =  vm.storageControllers[i].mediumAttachments[a].type;
					if(vm.storageControllers[i].mediumAttachments[a].medium && vm.storageControllers[i].mediumAttachments[a].medium.id) {
						medium = vm.storageControllers[i].mediumAttachments[a].medium.id;
					}
					a = vm.storageControllers[i].mediumAttachments.length;
				}
			}
			i = vm.storageControllers.length;
		}
	}

	$('#vboxMountDialog').data({'bus':bus,'port':port,'device':device,'busName':busName});

	/* Controller port/device name */
	$('#vboxMountController').html($('<div/>').text(busName + ' - ' + storage[bus].slotName(port,device)).html());
	$('#vboxMountMediumLabel').html(storage.getMediumName(storage.getMediumById(medium)));
	
	/* Drive Image */
	if(type == 'DVD') {

		var mAttachToolbar = new vboxButtonMenu(sButtonCD);
		mAttachToolbar.addButton('vboxMountToolbar');
		/*
		 * 
		 Menu for adding CD/DVD attachment
		 *
		 */
		if(!$('#vboxSettingsAddAttachmentsMenuCD').attr('id')) {
			var ul = document.createElement('ul');
			ul.setAttribute('class','contextMenu');
			ul.setAttribute('style','display: none');
			ul.setAttribute('id','vboxSettingsAddAttachmentsMenuCD');
			$('#vboxIndex').append(ul);
		} else {
			$('#vboxSettingsAddAttachmentsMenuCD').children().remove();
		}
		var ul = $('#vboxSettingsAddAttachmentsMenuCD');

		var li = document.createElement('li');
		li.innerHTML = "<a href='#chooseD' style='background-image: url(images/vbox/select_file_16px.png);' >"+trans('Choose a virtual CD/DVD disk file...')+"</a>";
		$(ul).append(li);
			
		// Add host drives
		var meds = storage.mediumsForAttachmentType('DVD');
		for(var i =0; i < meds.length; i++) {
			if(!meds[i].hostDrive) continue;
			var li = document.createElement('li');
			$(li).html("<a href='#"+meds[i].id+"'>"+storage.getMediumName(meds[i])+"</a>").appendTo(ul);
		}

		var li = document.createElement('li');
		li.innerHTML = "<a href='#removeD' style='background-image: url(images/vbox/cd_unmount_16px.png);' >"+trans('Remove disk from virtual drive')+"</a>";
		$(li).addClass('separator').addClass('vboxMediumRecentBefore');
		$(ul).append(li);


		mAttachToolbar.getButtonElm().contextMenu({
				menu: 'vboxSettingsAddAttachmentsMenuCD',
				mode:'menu',
				button: 0
			},
			function(action, el, pos) {
				switch(action) {
					case 'chooseD':
						vboxMountChooseMedium('DVD');		
						break;
					case 'removeD':
						vboxMountMedium(0);
						break;
					default: 
						if(action.indexOf('path:') == 0) {
							var path = action.substring(5);
							var med = storage.getMediumByLocation(path);
							if(med && med.deviceType == 'DVD') {
								vboxMountMedium(med);
							}
							return;
						}				
						vboxMountMedium(storage.getMediumById(action));
				}
			}
		);
		
		vboxSettingsStorageUpdateRecent('DVD');

		
	} else {
		
		var mAttachToolbar = new vboxButtonMenu(sButtonFD);
		mAttachToolbar.addButton('vboxMountToolbar');


		/*
		 * 
		 * Menu for adding floppy drive attachment
		 *
		 */
		if(!$('#vboxSettingsAddAttachmentsMenuFD').attr('id')) {
			var ul = document.createElement('ul');
			ul.setAttribute('class','contextMenu');
			ul.setAttribute('style','display: none');
			ul.setAttribute('id','vboxSettingsAddAttachmentsMenuFD');
			$('#vboxIndex').append(ul);
		} else {
			$('#vboxSettingsAddAttachmentsMenuFD').children().remove();
		}
		var ul = $('#vboxSettingsAddAttachmentsMenuFD');

		var li = document.createElement('li');
		li.innerHTML = "<a href='#chooseD' style='background-image: url(images/vbox/select_file_16px.png);' >"+trans('Choose a virtual floppy disk file...')+"</a>";
		$(ul).append(li);

		// Add host drives
		var meds = storage.mediumsForAttachmentType('Floppy');
		for(var i =0; i < meds.length; i++) {
			if(!meds[i].hostDrive) continue;
			var li = document.createElement('li');
			$(li).html("<a href='#"+meds[i].id+"'>"+storage.getMediumName(meds[i])+"</a>").appendTo(ul);
		}

		var li = document.createElement('li');
		li.innerHTML = "<a href='#removeD' style='background-image: url(images/vbox/fd_unmount_16px.png);' >"+trans('Remove disk from virtual drive')+"</a>";
		$(li).addClass('vboxMediumRecentBefore').addClass('separator');
		$(ul).append(li);
			
		mAttachToolbar.getButtonElm().contextMenu({
				menu: 'vboxSettingsAddAttachmentsMenuFD',
				mode:'menu',
				button: 0
			},
			function(action, el, pos) {
				switch(action) {
					case 'chooseD':
						vboxMountChooseMedium('Floppy');
						break;
					case 'removeD':
						vboxMountMedium(0);
						break;
					default:
						if(action.indexOf('path:') == 0) {
							var path = action.substring(5);
							var med = storage.getMediumByLocation(path);
							if(med && med.deviceType == 'Floppy') {
								vboxMountMedium(med);
							}
							return;
						}				
					vboxMountMedium(storage.getMediumById(action));
				}
			}
		);

		vboxSettingsStorageUpdateRecent('Floppy');
		
	}

}

function vboxMountMedium(medium) {
	
	// get values
	var vm = $('#vboxMountDialog').data('vboxMachineData');
	
	var args = {'vm':vm.id,'medium':medium,'port':$('#vboxMountDialog').data('port'),'device':$('#vboxMountDialog').data('device'),'bus':$('#vboxMountDialog').data('bus'),'controller':$('#vboxMountDialog').data('busName')};

	// Add to recents?
	if(medium && medium.id && !medium.hostDrive) {
		var changed = vboxAddRecentMedium(medium.location, $('#vboxMountDialog').data('vboxRecentMediums')[medium.deviceType]);
		if(changed)
			vboxAjaxRequest('mediumRecentUpdate',{'type':medium.deviceType,'list':$('#vboxMountDialog').data('vboxRecentMediums')[medium.deviceType]},function(){});			
	}
	
	// Ajax request to mount medium
	var mount = new vboxLoader();
	mount.mode = 'save';
	mount.add('mediumMount',function(ret,xtra){
		var l = new vboxLoader();
		l.add('VMDetails',function(d){$('#vboxIndex').data('vboxMachineData',d);},{'vm':xtra.vm});
		l.add('Mediums',function(d){$('#vboxIndex').data('vboxMediums',d);});
		l.onLoad = function() {
			$('#vboxIndex').trigger('vmselect',$('#vboxIndex').data('vboxMachineData'));
		}
		l.run();		
	},args);
	mount.run();
	$('#vboxMountDialog').empty().remove();
	
}


/*
 * 
 * Add recent mediums to list
 *
 */
function vboxSettingsStorageUpdateRecent(type) {
	var list = $('#vboxMountDialog').data('vboxRecentMediums')[type];
	switch(type) {
		case 'DVD':
			var elm = $('#vboxSettingsAddAttachmentsMenuCD');
			break;
		default:
			var elm = $('#vboxSettingsAddAttachmentsMenuFD');
			break;
	}
	elm.children('li.vboxMediumRecent').remove();
	var ins = elm.children('li.vboxMediumRecentBefore').last();
	for(var i = 0; i < list.length; i++) {
		if(!list[i]) continue;
		var li = document.createElement('li');
		$(li).attr({'class':'vboxMediumRecent'}).html("<a href='#path:"+list[i]+"'>"+vboxBasename(list[i])+"</a>").insertBefore(ins);
	}
}

/* Choose existing medium */
function vboxMountChooseMedium(type) {

	vboxFileBrowser(vboxDirname($('#vboxMountDialog').data('vboxMachineData').settingsFilePath),function(f){
		if(!f) return;
		var med = storage.getMediumByLocation(f);
		if(med && med.deviceType == type) {
			vboxMountMedium(med);
			return;
		} else if(med) {
			return;
		}
		var ml = new vboxLoader();
		ml.mode='save';
		ml.add('mediumAdd',function(ret){
			var l = new vboxLoader();
			if(ret && ret.id) {
				var med = storage.getMediumById(ret.id);
				// Not registered yet. Refresh mediums.
				if(!med)
					l.add('Mediums',function(data){$('#vboxIndex').data('vboxMediums',data);});
			}
			l.onLoad = function() {
				if(ret && ret.id) {
					var med = storage.getMediumById(ret.id);
					if(med && med.deviceType == type) {
						vboxMountMedium(med);
						return;
					}
				}
			}
			l.run();
		},{'path':f,'type':type});
		ml.run();
	});
	
}

</script>
</div>