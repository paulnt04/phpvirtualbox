<!--

	Shared Folders
	Copyright (C) 2011 Ian Moore (imoore76 at yahoo dot com)
	
	$Id$
	
-->
<table style='width: 100%' id='vboxSettingsSharedFoldersTable'>
	<tr style='vertical-align: middle'>
		<td style='width: 100%'>
		<table class='vboxSettingsHeadingLine' style='width:100%;border-spacing:0;border:0px;margin:0px;padding:0px;'><tr style='vertical-align:middle'><td style='white-space: nowrap; width: auto;'><span class='translate'>Folders List</span></td><td style='width: 100%'><hr style='width: 100%;'  class='vboxSeperatorLine'/></td></tr></table>
		</td>
	</tr>
	<tr>
		<td style='width: 100%'>
		<table style='width: 100%'>
			<tr>
				<td style='width: 100%'>
				<div style='overflow: auto;' class='vboxBordered' id='vboxSettingsSharedFolders'>
				<table class='vboxHorizontal' id='vboxSettingsSharedFoldersList'>
					<thead>
						<tr id='vboxSettingsSharedFoldersHeading'>
							<th><span class='translate'>Name</span></th>
							<th style='width: 100%; white-space: nowrap;'><span class='translate'>Path</span></th>
							<th><span class='translate'>Auto-Mount</span></th>
							<th><span class='translate'>Access</span></th>
						</tr>
					</thead>
				</table>
				</div>
				</td>
				<td id='vboxSettingsSFButtons'></td>
			</tr>
		</table>
		</td>
	</tr>

</table>
<script type='text/javascript'>

/*
 * Init Shared Folder buttons and toolbar
 */

var sButtons = new Array(

	{
		'name' : 'addshared',
		'label' : 'Add Shared Folder',
		'icon' : 'add_shared_folder',
		'enabled' : function (item) { return true; },
		'click' : function () {

			var dialog = vboxSettingsSFEditDialog();
			
			$('#vboxSettingsSFPath').val('');
			$('#vboxSettingsSFName').val('');
			$('#vboxSettingsSFAM').attr('checked','');
			$('#vboxSettingsSFRO').attr('checked','');
			$('#vboxSettingsSFPerm').attr('checked','');
			
			var buttons = { };
			buttons[trans('OK')] = function() {
				if($('#vboxSettingsSFName').val() && $('#vboxSettingsSFPath').val()) {
					var f = {'name':$('#vboxSettingsSFName').val(),'hostPath':$('#vboxSettingsSFPath').val(),'autoMount':($('#vboxSettingsSFAM').attr('checked')),'writable':!($('#vboxSettingsSFRO').attr('checked'))};
					if($('#vboxSettingsSFPerm').attr('id'))
						f['type'] = ($('#vboxSettingsSFPerm').attr('checked') ? 'machine' : '');
					else
						f['type'] = 'machine';
					var row = vboxSettingsAddSharedFolder(f);
					$(row).children('td').last().trigger('click');
				}
				$(dialog).empty().remove();
			};
			buttons[trans('Cancel')] = function() { $(dialog).empty().remove(); };
			$(dialog).dialog({'buttons':buttons}).dialog('open');
			
		}
	},

	{
		'name' : 'editshared',
		'label' : 'Edit Shared Folder',
		'icon' : 'edit_shared_folder',
		'enabled' : function (item) { return $(item).hasClass('vboxListItemSelected');  },
		'click' : function () {

			var dialog = vboxSettingsSFEditDialog();
			
			// TODO
			var def = $('#vboxSettingsSharedFoldersList').find('tr.vboxListItemSelected').first();
			$('#vboxSettingsSFPath').val(($(def).data('hostPath')||''));
			$('#vboxSettingsSFName').val(($(def).data('name')||''));
			$('#vboxSettingsSFAM').attr('checked',($(def).data('autoMount') ? 'checked' : ''));
			$('#vboxSettingsSFRO').attr('checked',($(def).data('writable') ? '' : 'checked'));
			$('#vboxSettingsSFPerm').attr('checked',($(def).data('type') == 'machine' ? 'checked' : ''));

			var buttons = { };
			buttons[trans('OK')] = function() {
				if($('#vboxSettingsSFName').val() && $('#vboxSettingsSFPath').val()) {
					// TODO
					var item = $('#vboxSettingsSharedFoldersList').find('tr.vboxListItemSelected').first();
					$(item).data('hostPath',$('#vboxSettingsSFPath').val());
					$(item).data('name',$('#vboxSettingsSFName').val());
					$(item).data('autoMount',($('#vboxSettingsSFAM').attr('checked')));
					$(item).data('writable',!($('#vboxSettingsSFRO').attr('checked')));
					if($('#vboxSettingsSFPerm').attr('id'))
						$(item).data('type',($('#vboxSettingsSFPerm').attr('checked') ? 'machine' : ''));
					else
						$(item).data('type','machine');
					$(item).trigger('refresh');
				}
				$(dialog).empty().remove();
			};
			buttons[trans('Cancel')] = function() { $(dialog).empty().remove() };
			$(dialog).dialog({'buttons':buttons}).dialog('open');
		
		}		
	},
	
	{
		'name' : 'removeshared',
		'label' : 'Remove Shared Folder',
		'icon' : 'remove_shared_folder',
		'enabled' : function (item) { return $(item).hasClass('vboxListItemSelected'); },
		'click' : function () {
			// TODO
			var item = $('#vboxSettingsSharedFoldersList').find('.vboxListItemSelected').first();
			var target = $(item).next();
			if(!$(target).hasClass('vboxListItemSelected')) target = $(item).prev();
			if(!$(target).hasClass('vboxListItemSelected')) target = $('#vboxSettingsSharedFoldersList').find('.vboxListItem').first();
			$('#vboxSettingsSharedFoldersList').find('tr.vboxListItemSelected').first().remove();
			if(!$(target).children().first().trigger('click').hasClass('vboxListItemSelected')) {
				$('#vboxSettingsSharedFoldersList').trigger('select',null);
			}
		}		
	}

 );

sfToolbar = new vboxToolbarSmall(sButtons);
sfToolbar.addButtons('vboxSettingsSFButtons');
$('#vboxSettingsSharedFoldersList').bind('select',sfToolbar.update);

/* Add Shared Folder to list */

function vboxSettingsAddSharedFolder(f, noColor) {
	
	var tr = document.createElement('tr');
	tr.setAttribute('class','vboxListItem');
	
	if(f.type == 'machine') {
		$(tr).addClass('vboxSFMachine');
	} else {
		$(tr).addClass('vboxSFTransient');
	}
	
	// Bind data
	$(tr).data(f);
	
	var td = document.createElement('td');
	td.setAttribute('class','vboxSettingsSFNameCell vboxHoverFirst');
	var img = document.createElement('img');
	$(img).attr({'src':'images/vbox/blank.gif','style':'height: 10px; width: 30px;'});
	td.appendChild(img);
	var sp = document.createElement('span');
	sp.innerHTML = $('<div/>').text(f.name).html();
	td.appendChild(sp);
	tr.appendChild(td);
	var td = document.createElement('td');
	td.setAttribute('class','vboxSettingsSFPathCell vboxHoverMid');
	td.innerHTML = $('<div/>').text(f.hostPath).html();
	tr.appendChild(td);
	var td = document.createElement('td');
	td.setAttribute('class','vboxSettingsSFAMCell vboxHoverMid');
	td.innerHTML = f.autoMount ? trans('Yes') : trans('No');
	tr.appendChild(td);			
	var td = document.createElement('td');
	td.setAttribute('class','vboxSettingsSFROCell vboxHoverLast');
	td.innerHTML = f.writable ? trans('Full Access') : trans('ro');
	tr.appendChild(td);		

	// bind refresh
	$(tr).bind('refresh',function(){
		
		$(this).children('td.vboxSettingsSFNameCell').children('span').first().html($('<div/>').text($(this).data('name')).html());
		$(this).children('td.vboxSettingsSFPathCell').html($('<div/>').text($(this).data('hostPath')).html());
		$(this).children('td.vboxSettingsSFAMCell').html($(this).data('autoMount') ? trans('Yes') : trans('No'));
		$(this).children('td.vboxSettingsSFROCell').html($(this).data('writable') ? trans('Full Access') : trans('ro'));
		
		// Move from one type to another
		if($(this).data('type') == 'machine' && $(this).hasClass('vboxSFTransient')) {
			$(this).removeClass('vboxSFTransient').addClass('vboxSFMachine').detach().appendTo('#vboxSFMachineBody');
			vboxColorRows($('#vboxSFMachineBody'));
			vboxColorRows($('#vboxSFTransientBody'));
		} else if($(this).data('type') != 'machine' && $(this).hasClass('vboxSFMachine')) {
			$(this).removeClass('vboxSFMachine').addClass('vboxSFTransient').detach().appendTo('#vboxSFTransientBody');
			vboxColorRows($('#vboxSFMachineBody'));
			vboxColorRows($('#vboxSFTransientBody'));			
		}
	}).hover(function(){$(this).addClass('vboxHover');},function(){$(this).removeClass('vboxHover');}).children().click(function(){
		$('#vboxSettingsSharedFoldersList').find('tr.vboxListItemSelected').removeClass('vboxListItemSelected').addClass('vboxListItem');
		$(this).parent().removeClass('vboxListItem').addClass('vboxListItemSelected');
		$('#vboxSettingsSharedFoldersList').trigger('select',$(this).parent());

	}).dblclick(function(e){
		sfToolbar.click('editshared');
		e.preventDefault();
	}).attr('unselectable','on').css('MozUserSelect','none');
	
	if(f.type == 'machine') {
		$('#vboxSFMachineBody').append(tr);
		if(!noColor) vboxColorRows($('#vboxSFMachineBody'));
	} else {
		$('#vboxSFTransientBody').append(tr);
		if(!noColor) vboxColorRows($('#vboxSFTransientBody'));
	}

	
	return tr;
}

/* Shared Folders */
var sfh = $('#vboxSettingsSharedFoldersList');

/* 
 * 
  Add 'Machine Folder's
 *
 */ 
var tb = document.createElement('tbody');
tb.setAttribute('id','vboxSFMachineBody');
$(tb).addClass('vboxHover');
var tr = document.createElement('tr');
tr.setAttribute('class','vboxListItemDisabled');
var td = document.createElement('td');
td.setAttribute('class','vboxSettingsSFNameCell');
var btn = document.createElement('input');
$(btn).attr({'type':'button','class':'vboxImgButton','style':'background-image: url(images/vbox/arrow_down_10px.png); width: 12px; height: 12px; margin-right: 4px;'}).toggle(function(){
		$(this).css({'background-image':'url(images/vbox/arrow_right_10px.png)'});
		$('#vboxSettingsSharedFoldersList').trigger('select',null);
		$('#vboxSFMachineBody').children('tr.vboxSFMachine').css({'display':'none'}).removeClass('vboxListItemSelected').addClass('vboxListItem');
	},function(){
		$(this).css({'background-image':'url(images/vbox/arrow_down_10px.png)'});
		$('#vboxSettingsSharedFoldersList').trigger('select',null);
		$('#vboxSFMachineBody').children('tr.vboxSFMachine').css({'display':''});
}).appendTo(td);
var sp = document.createElement('span');
sp.innerHTML  = $('<div/>').text(trans('Machine Folders')).html();
td.appendChild(sp);
tr.appendChild(td);
var td = document.createElement('td');
td.setAttribute('class','vboxSettingsSFPathCell');
tr.appendChild(td);
var td = document.createElement('td');
td.setAttribute('class','vboxSettingsSFAMCell');
tr.appendChild(td);			
var td = document.createElement('td');
td.setAttribute('class','vboxSettingsSFROCell');
tr.appendChild(td);		
$(tr).attr('unselectable','on').css('MozUserSelect','none');
$(tb).append(tr).appendTo(sfh);


/*
 * 
 * Add 'Transient Folders' if machine is running
 *
 */
 if($('#vboxSettingsDialog').data('vboxMachineData').state == 'Running') {

	 var tb = document.createElement('tbody');
	 tb.setAttribute('id','vboxSFTransientBody');
	 $(tb).addClass('vboxHover');
	 var tr = document.createElement('tr');
	 tr.setAttribute('class','vboxListItemDisabled');

	 var td = document.createElement('td');
	 td.setAttribute('class','vboxSettingsSFNameCell');
	 var btn = document.createElement('input');
	 btn.setAttribute('type','button');
	 btn.setAttribute('class','vboxImgButton');
	 btn.setAttribute('style','background-image: url(images/vbox/arrow_down_10px.png); width: 12px; height: 12px; margin-right: 4px;');
	 $(btn).toggle(function(){
	 		$(this).css({'background-image':'url(images/vbox/arrow_right_10px.png)'});
			$('#vboxSettingsSharedFoldersList').trigger('select',null);
			$('#vboxSFTransientBody').children('tr.vboxSFTransient').css({'display':'none'}).removeClass('vboxListItemSelected').addClass('vboxListItem');	 		
	 	},function(){
	 		$(this).css({'background-image':'url(images/vbox/arrow_down_10px.png)'});
	 		$('#vboxSettingsSharedFoldersList').trigger('select',null);
	 		$('#vboxSFTransientBody').children('tr.vboxSFTransient').css('display','');
	 });
	 $(td).append(btn);
	 var sp = document.createElement('span');
	 sp.innerHTML  = $('<div/>').text(trans('Transient Folders')).html();
	 td.appendChild(sp);
	 tr.appendChild(td);
	 var td = document.createElement('td');
	 td.setAttribute('class','vboxSettingsSFPathCell');
	 tr.appendChild(td);
	 var td = document.createElement('td');
	 td.setAttribute('class','vboxSettingsSFAMCell');
	 tr.appendChild(td);			
	 var td = document.createElement('td');
	 td.setAttribute('class','vboxSettingsSFROCell');
	 tr.appendChild(td);		
	 $(tr).attr('unselectable','on').css('MozUserSelect','none');
	 $(tb).append(tr).appendTo(sfh);

	// add each transient folder
	 for(var i = 0; i < $('#vboxSettingsDialog').data('vboxTransientSharedFolders').length; i++) {
	 	vboxSettingsAddSharedFolder($('#vboxSettingsDialog').data('vboxTransientSharedFolders')[i]);
	 }
	 

 }
 
// add each machine folder
for(var i = 0; i < $('#vboxSettingsDialog').data('vboxMachineData').sharedFolders.length; i++) {
	vboxSettingsAddSharedFolder($('#vboxSettingsDialog').data('vboxMachineData').sharedFolders[i]);
}


/* Update Shared Folder path and name. Callback for folder browser */
function vboxSettingsSFUpdatePath(f) {
	if(!f) return;
	$('#vboxSettingsSFPath').val(f);
	if(!$('#vboxSettingsSFName').val()) {
		f = f.replace(/.*\//,'');
		f = f.replace(/.*\\/,'');
		if(f) $('#vboxSettingsSFName').val(f);
	}
}
/* 
 * 
 *
 *		Shared Folder Properties Screen
 *
 *
 */
function vboxSettingsSFEditDialog() {
	
	var d = document.createElement('div');
	d.setAttribute('id','vboxSettingsSFEdit');
	d.setAttribute('class','vboxNonTabbed vboxDialogContent');
	d.setAttribute('style','display: none;');
	var tbl = document.createElement('table');
	tbl.setAttribute('style','width: 100%');
	tbl.setAttribute('class','vboxSettingsTable');
	
	var tr = document.createElement('tr');
	$(tr).attr('style','vertical-align: middle');
	var th = document.createElement('th');
	th.setAttribute('style','white-space: nowrap');
	th.innerHTML = trans('Path') + ':';
	tr.appendChild(th);
	var td = document.createElement('td');
	td.setAttribute('style','white-space: nowrap');
	td.innerHTML = '<table style="width: 100%"><tr><td style="width: 100%"><input type="text" class="vboxText" id="vboxSettingsSFPath" style="width: 100%"/></td><td style="width: auto" class="vboxFileFolderInput"><input type="button" class="vboxImgButton" style="background-image: url(images/vbox/select_file_16px.png)" onClick="browseFolder($(\'#vboxSettingsSFPath\').val(),vboxSettingsSFUpdatePath);" /></td></tr></table>';
	tr.appendChild(td);
	tbl.appendChild(tr);
	
	var tr = document.createElement('tr');
	var th = document.createElement('th');
	th.innerHTML = trans('Name') + ':';
	tr.appendChild(th);
	var td = document.createElement('td');
	td.innerHTML = '<input type="text" class="vboxText" id="vboxSettingsSFName" style="width: 100%" />';
	tr.appendChild(td);
	tbl.appendChild(tr);
	
	var tr = document.createElement('tr');
	var th = document.createElement('th');
	tr.appendChild(th);
	var td = document.createElement('td');
	td.innerHTML = '<input type="checkbox" class="vboxCheckbox" id="vboxSettingsSFRO" /> ' + trans('ro'); // "Read-only"
	tr.appendChild(td);
	tbl.appendChild(tr);

	var tr = document.createElement('tr');
	var th = document.createElement('th');
	tr.appendChild(th);
	var td = document.createElement('td');
	td.innerHTML = '<input type="checkbox" class="vboxCheckbox" id="vboxSettingsSFAM" /> ' + trans('Auto-Mount');
	tr.appendChild(td);
	tbl.appendChild(tr);
	
	// Add "Make Permanent"?
	if($('#vboxSettingsDialog').data('vboxMachineData').state != 'PoweredOff') {
		var tr = document.createElement('tr');
		var th = document.createElement('th');
		tr.appendChild(th);
		var td = document.createElement('td');
		td.innerHTML = '<input type="checkbox" class="vboxCheckbox" id="vboxSettingsSFPerm" /> ' + trans('Make Permanent');
		tr.appendChild(td);
		tbl.appendChild(tr);		
	}
	
	d.appendChild(tbl);
	
	$('#vboxIndex').append(d);
	
	$('#vboxSettingsSFEdit').dialog({'width':800,'modal':true,'autoOpen':false,'stack':true,'dialogClass':'vboxNonTabbed','title':trans('Shared Folder')});

	return $('#vboxSettingsSFEdit');
}



/* Change settings onSave() */
$('#vboxSettingsDialog').bind('save',function(){

	$('#vboxSettingsDialog').data('vboxMachineData').sharedFolders = new Array();

	var folders = new Array();	
	$('#vboxSettingsSharedFoldersList').find('tr').each(function(){
		// Skip headers and such
		if($(this).data('name')) {
			folders[folders.length] = {'name':$(this).data('name'),'hostPath':$(this).data('hostPath'),'autoMount':($(this).data('autoMount') ? 1 : 0),'writable':($(this).data('writable') ? 1 : 0),'type':$(this).data('type')};
		}
	});
	$('#vboxSettingsDialog').data('vboxMachineData').sharedFolders = folders;

});

</script>

