<!-- 

	VM Details
	
	$Id$

 -->
<div id='vboxTabVMDetails' style='height: 100%;' class='vboxInvisible'>
	<div id='vboxVMDetails' style='height: 100%;' class='vboxInvisible'>
	</div>
<script type='text/javascript'>

// Cookies used for show/hide boxes
vboxParseCookies();

// Listen for events
$('#vboxTabVMDetails').parent().bind('vmloading',function(){

	// Clear timer if it is set
	if($('#vboxVMDetails').data('vboxPreviewTimer')) {
		window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
		$('#vboxVMDetails').data('vboxPreviewTimer', null);
	}
	
	$('#vboxVMDetails').css({'vertical-align':'middle'});
	$('#vboxVMDetails').html("<div class='vboxTabLoading'><img src='images/spinner.gif'></div>");
});

$('#vboxTabVMDetails').parent().bind('vmloaded',function(e,vm){

	// vboxTabVMDetails
	if(vm && vm.id) {

		$('#vboxVMDetails').data('vmid', vm.id);
		$('#vboxVMDetails').css({'vertical-align':'top'});
		__vboxTabVMDetails(vm);
		
	} else {
		
		$('#vboxVMDetails').css({'vertical-align':'middle'});
		$('#vboxVMDetails').html('<div class="vboxTabLoading" style="height: 100%; background: #fff;"><img src="images/vbox/welcome.png" /></div>');

		// Clear timer if it is set
		if($('#vboxVMDetails').data('vboxPreviewTimer')) {
			window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
			$('#vboxVMDetails').data('vboxPreviewTimer', null);
		}
	
	}
});


//Called when VM selection changes
function __vboxTabVMDetails(vm) {
	
	if(vm.id == 'host') {

		// Clear timer if it is set
		if($('#vboxVMDetails').data('vboxPreviewTimer')) {
			window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
			$('#vboxVMDetails').data('vboxPreviewTimer', null);
		}
		
		__vboxDisplayHostDetailsData(vm);
		
	} else {
		__vboxDisplayDetailsData(vm,null,true,true);
	}
}

// Returns link to settings
function __vboxDetailSettingsLink(text,section,id) {
	var link = document.createElement('a');
	$(link).attr('href',"javascript:vboxVMsettingsInit('"+id+"',function(){$('#vboxIndex').trigger('vmselect',[$('#vboxIndex').data('selectedVM')]);},'"+section+"');");
	$(link).html(text);
	return link;
}

//Returns table row (tr) element for details header
function __vboxDetailHeader(icon,name,linkto,vm,boxes) {

	var tr = document.createElement('tr');
	tr.setAttribute('class','vboxDetailsHead');
	var th = document.createElement('th');
	th.setAttribute('class','vboxDetailsSection');
	th.setAttribute('colspan', '2');

	if(boxes) {
		var div = document.createElement('div');
		$(div).html("<img style='float:left;  margin-right: 3px;' src='images/vbox/" + icon + "' /> ");
	} else {
		th.innerHTML = "<img style='float:left; margin-right: 3px; ' src='images/vbox/" + icon + "' /> ";
	}

	var sp = document.createElement('span');
	$(sp).css({'float':'left'});
	// Create links to settings?
	if(typeof linkto == "string") {
		$(sp).append(__vboxDetailSettingsLink(trans(name)+' ',linkto,vm.id));
	} else {
		$(sp).append(document.createTextNode(trans(name)+' '));
	}
	
	if(boxes) $(div).append(sp);
	else $(th).append(sp);
	
	var sp = document.createElement('span');
	$(sp).attr('class','vboxDetailsUpDnImgSpan');
	$(sp).css({'float':'right'});
	if(boxes) {
		var udimg = document.createElement('img');
		$(udimg).attr({'src':'images/arrow_grad_up.png'});
		$(sp).append(udimg);
		$(div).append(sp);
		$(th).append(div);
	} else {
		$(th).append(sp);
	}
	tr.appendChild(th);

	return tr;
}

//Base function that returns a table row of machine detail data
//Called from other functions
function __vboxDetailRowReal(name,value,cssClass,html) {
	var tr = document.createElement('tr');
	var th = document.createElement('th');
	th.appendChild(document.createTextNode(name + (value.length && name.length ? ':' : '')));
	th.setAttribute('class','vboxDetailContent ' + cssClass);
	
	var td = document.createElement('td');
	td.setAttribute('class','vboxDetailsValue');
	if(html) {
		td.innerHTML = value;
	} else { 
		td.appendChild(document.createTextNode(value));
	}
	tr.appendChild(th);
	tr.appendChild(td);

	return tr;
}
//Return normal detail row
function __vboxDetailRow(name,value,html) {
	return __vboxDetailRowReal(name,value,'vboxDetailName',html);
}
//Return indented detail row
function __vboxDetailRowIndented(name,value,html) {
	return __vboxDetailRowReal(name,value,'vboxDetailNameIndent',html);
}

// Draw preview scren
var __vboxDrawPreviewImg = null;
function __vboxDrawPreview(vmid,fromSelf) {

	if(!fromSelf && $('#vboxVMDetails').data('vboxPreviewTimer')) {
		window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
		$('#vboxVMDetails').data('vboxPreviewTimer', null);
	}
			
	$(__vboxDrawPreviewImg).remove();
	var w = $('#vboxIndex').data('vboxConfig')['previewWidth'];
	__vboxDrawPreviewImg = document.createElement('img');
	__vboxDrawPreviewImg.onload = function(){
		
		// Error or machine not running
		if(this.height <= 1) {

			var width = $('#vboxIndex').data('vboxConfig')['previewWidth'];
			if(!width) width = 200;
			var height = (width * 3.0/4.0);
			src = 'images/vbox/monitor_glossy.png';
			$('#vboxDetailsPreviewVMName').css('display','');
			
			// Clear timer if it is set
			if($('#vboxVMDetails').data('vboxPreviewTimer')) {
				window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
				$('#vboxVMDetails').data('vboxPreviewTimer', null);
			}

		} else {
			$('#vboxDetailsPreviewWrap').css({'background-image':'none'});
			var height = this.height;
			var width = this.width;
			src = this.src;
			$('#vboxDetailsPreviewVMName').css('display','none');
			// Keep refreshing preview
			$('#vboxVMDetails').data('vboxPreviewTimer',window.setTimeout(function(){
				__vboxDrawPreview(vmid,true);
			},$('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] * 1000));
		}
		$('#vboxDetailsPreviewWrap').css({'height':height+'px','width':width+'px','background-color':'#000','background-image':'url('+src+')'});
	};

	// Update disabled?
	if($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] == 0) {
		__vboxDrawPreviewImg.height = 0;
		__vboxDrawPreviewImg.onload();
	} else {
		__vboxDrawPreviewImg.src = 'screen.php?width='+(w ? w : '200')+'&vm='+vmid+'&rand='+Math.random();
	}

}
//Display details data table for VM
//////////////////////////////////
function __vboxDisplayDetailsData(data,targetdiv,links,boxes) {

	// Defaults
	if(!targetdiv)
		targetdiv = $('#vboxVMDetails');

	if(links === undefined)
		links = true;

	var settings = (links == true && data.sessionState == 'Unlocked' && data.state != 'Saved');

	 
	// clear progress bar or existing data
	$(targetdiv).html('');

	// Accessibility check
	if(data.state == 'Inaccessible') {

		$(targetdiv).html('<div style="width: 50%">'+trans('VM Inaccessible')+'</div>');
		
		// Details Table
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('style','width: 50%');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableError');
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Error"), data.accessError['text']));
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Result Code"), data.accessError['resultCode']));
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Component"), data.accessError['component']));
		$(targetdiv).append(vboxDetailsTable);

		var d = document.createElement('div');
		d.setAttribute('style','width: 50%; padding: 4px;');
		
		var btn = document.createElement('input');
		btn.setAttribute('type','button');
		btn.setAttribute('value',trans('Refresh'));
		btn.setAttribute('style','background: url(images/vbox/refresh_16px.png) 2px 2px no-repeat; padding: 2px 2px 2px 18px; border: 1px solid #000; background-color: #eee; ');
		$(btn).click(function(){
			var l = new vboxLoader();
			l.add('VMDetails',function(){
				$('#vboxIndex').trigger('vmselect',[$('#vboxIndex').data('selectedVM')]);
			},{'vm':$('#vboxIndex').data('selectedVM').id,'force_refresh':1});
			l.run();
		});

		$(d).append(btn);
		
		$(targetdiv).append(d);
				
		return;
	}

	// Wrap table around General and system for Preview window
	if(boxes) {
		var tbl = document.createElement('table');
		tbl.setAttribute('class','vboxInvisible');
		tbl.setAttribute('style','width: 100%');
		var tr = document.createElement('tr');
		$(tr).css('vertical-align','top');
	}
	
	// Details Table
	var vboxDetailsTable = document.createElement('table');
	vboxDetailsTable.setAttribute('id','vboxDetailsTable' + (boxes ? 'BoxGeneral' : 'General'));
	vboxDetailsTable.setAttribute('class','vboxDetailsTable' + (boxes ? ' vboxDetailsTableBox ui-corner-all' : ''));

	// General
	vboxDetailsTable.appendChild(__vboxDetailHeader("machine_16px.png","General",(settings ? 'General' : null),(settings ? data : null),boxes));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Name"), data['name']));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("OS Type"), trans(data['OSTypeId'])));

	// Account for preview box
	if(boxes) {
		
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowGeneral"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}

		var td = document.createElement('td');
		$(td).css('width','100%'); 
		$(td).append(vboxDetailsTable);
		
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxSystem');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	}		

	// System
	vboxDetailsTable.appendChild(__vboxDetailHeader('chipset_16px.png',"System",(settings ? 'System' : null),(settings ? data : null),boxes));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Base Memory"), data['memorySize'] + " " + trans('MB')));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Processors"), data['CPUCount']));
	
	// Boot Order
	var bo = new Array();
	for(var i = 0; i < data['bootOrder'].length; i++) {
		bo[i] = trans(data['bootOrder'][i]);
	}
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Boot Order"), bo.join(trans('LIST_SEP'))));

	// HW acceleration config enabled?
	if($('#vboxIndex').data('vboxConfig').enableAccelerationConfig) {
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("VCPU"), (data['HWVirtExProperties'].Enabled ? trans('Enabled') : trans('Disabled'))));
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Nested Paging"), (data['HWVirtExProperties'].NestedPaging ? trans('Enabled') : trans('Disabled'))));
	}

	// Account for preview box
	if(boxes) {
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowSystem"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}
		$(td).append(vboxDetailsTable);
		$(tr).append(td);
		
		var td = document.createElement('td');

		// Preview box
		/////////////////////
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxPreview');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
		vboxDetailsTable.appendChild(__vboxDetailHeader("fullscreen_16px.png","Preview",null,null,boxes));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowPreview"] == 0 || !$('#vboxIndex').data('vboxConfig').imagepng) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}

		var tdr = document.createElement('tr');
		$(tdr).attr('vertical-align','middle');
		var tdp = document.createElement('td');
		$(tdp).css({'text-align':'center'});
		$(tdp).attr('colspan','2');

		var w = $('#vboxIndex').data('vboxConfig')['previewWidth'];
		if(!w) w = 200;
		var h = (w * 3.0/4.0);
		var divWrap = document.createElement('div');
		$(divWrap).attr('id','vboxDetailsPreviewWrap');
		$(divWrap).attr('style','background-color:#000;background-image:url(images/vbox/monitor_glossy.png);border:0px;display:table;height:'+h+'px;width:'+w+'px;#position:relative;background-repeat: no-repeat;');

		// PHP has GD extension installed ?
		if($('#vboxIndex').data('vboxConfig').imagepng) {

			// Clear timer if it is set
			if($('#vboxVMDetails').data('vboxPreviewTimer')) {
				window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
				$('#vboxVMDetails').data('vboxPreviewTimer', null);
			}
			
			var divOut1 = document.createElement('div');
			$(divOut1).attr('style','#position:absolute;#top:50%;display:table-cell;vertical-align:middle;');
			var divOut2 = document.createElement('div');
			$(divOut2).attr('id','vboxDetailsPreviewVMName');
			$(divOut2).attr('style','#position:relative;#top:-50%;padding:4px;color:#fff;font-weight:bold;text-align:center;');
			$(divOut2).html($('<div />').html(data.name).text());
			$(divOut1).append(divOut2);
			$(divWrap).append(divOut1);

			if((data.state == 'Running' || data.state == 'Saved') && $('#vboxIndex').data('vboxCookies')["vboxSectionShowPreview"] != 0) {

				__vboxDrawPreview(data.id);
								
			} else {
				// Clear timer if it is set
				if($('#vboxVMDetails').data('vboxPreviewTimer')) {
					window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
					$('#vboxVMDetails').data('vboxPreviewTimer', null);
				}
			}
		}
				

		$(tdp).append(divWrap);
		
		$(tdr).append(tdp);
		vboxDetailsTable.appendChild(tdr);
		
		$(td).append(vboxDetailsTable);
		$(tr).append(td);
		$(tbl).append(tr);
		
		$(targetdiv).append(tbl);
		
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxDisplay');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	}		
	
	// Display 
	vboxDetailsTable.appendChild(__vboxDetailHeader("fullscreen_16px.png","Display",(settings ? 'Display' : null),(settings ? data : null),boxes));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Video Memory"), data['VRAMSize'] + " " + trans('MB')));
	/* Unsupported at this time. 
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Video 3d"), (data['accelerate3DEnabled'] ? trans("Enabled") : trans("Disabled"))));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Video 2d"), (data['accelerate2DVideoEnabled'] ? trans("Enabled") : trans("Disabled"))));
	*/
	

	// RDP
	if(data['VRDPServer'] && data['VRDPServer']['enabled'] && data['VRDPServer']['ports']) {
		if(data['VRDPServer']['netAddress']) {
			vboxDetailsTable.appendChild(__vboxDetailRow(trans("Remote Console")+ ': ' +trans("Net Address"), data['VRDPServer']['netAddress']));
		}

		var chost = data['VRDPServer']['netAddress'];
		if(!chost) chost = $('#vboxIndex').data('vboxConfig').consoleHost;
		if(!chost || chost == 'localhost' || chost == '127.0.0.1') {chost = location.host;}
		
		if(links) {
			tr = __vboxDetailRow(trans("Ports"), data['VRDPServer']['ports']);
			tr.childNodes[1].innerHTML = "<a href='rdp.php?host=" + chost + '&port=' + data['VRDPServer']['ports'] + "&vm=" + encodeURIComponent(data['name']) + "'>" + data['VRDPServer']['ports'] + "</a>";
			vboxDetailsTable.appendChild(tr);
		} else {
			vboxDetailsTable.appendChild(__vboxDetailRow(trans("Remote Console")+ ': ' +trans("Ports"), data['VRDPServer']['ports']));
		}
		
	}

	if(boxes) {
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowDisplay"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}		
		$(targetdiv).append(vboxDetailsTable);
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxStorage');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	}		
	
	// Storage
	vboxDetailsTable.appendChild(__vboxDetailHeader("hd_16px.png","Storage",(settings ? 'Storage' : null),(settings ? data : null),boxes));
	storage = new vboxStorage();
	for(var a = 0; a < data['storageControllers'].length; a++) {
		
		var con = data['storageControllers'][a];
		
		vboxDetailsTable.appendChild(__vboxDetailRow(con.name, ''));
		
		for(var b = 0; b < data['storageControllers'][a]['mediumAttachments'].length; b++) {
			
			var portName = storage[data['storageControllers'][a].bus].slotName(data['storageControllers'][a]['mediumAttachments'][b].port, data['storageControllers'][a]['mediumAttachments'][b].device);

			// Medium / host device info
			var medium = (data['storageControllers'][a]['mediumAttachments'][b].medium && data['storageControllers'][a]['mediumAttachments'][b].medium.id ? storage.getMediumById(data['storageControllers'][a]['mediumAttachments'][b].medium.id) : null);

			// Get base medium (snapshot -> virtual disk file)
			if(medium && medium.base && (medium.base != medium.id)) {
				for(var x in $('#vboxIndex').data('vboxMediums')) {
					if($('#vboxIndex').data('vboxMediums')[x].id == medium.base) {
						medium = $('#vboxIndex').data('vboxMediums')[x];
						break;
					}
				}
			}

			portDesc = storage.mediumPrint(medium);

			// Link medium to mount?
			if(links && data['storageControllers'][a]['mediumAttachments'][b].type != 'HardDisk' && (data.state == 'Running' || (data.state == 'PoweredOff' && data.sessionState == 'Unlocked'))) {
				portDesc = $('<div />').text(portDesc).html();
				portDesc = '<a href="javascript:vboxMountInit(\''+data['id']+'\',\''+data['storageControllers'][a].bus+'\','+data['storageControllers'][a]['mediumAttachments'][b].port+','+data['storageControllers'][a]['mediumAttachments'][b].device+',__vboxTabVMDetails)">'+portDesc+'</a>';
			}
			vboxDetailsTable.appendChild(__vboxDetailRowIndented(portName + (data['storageControllers'][a]['mediumAttachments'][b].type == 'DVD' ? ' (' + trans(data['storageControllers'][a]['mediumAttachments'][b].type) + ') ' : ''), portDesc,(data['storageControllers'][a]['mediumAttachments'][b].type != 'HardDisk' ? true : false)));
			
		}
		
	}
	
	if(boxes) {
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowStorage"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}
		$(targetdiv).append(vboxDetailsTable);
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxAudio');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	}		
	
	// Audio (uncomment here and in vboxconnector.php if you'd like 
	vboxDetailsTable.appendChild(__vboxDetailHeader("sound_16px.png","Audio",(settings ? 'Audio' : null),(settings ? data : null),boxes));
	if(!data['audioAdapter']['enabled']) {
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Disabled"), ""));
	} else {
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Host Audio Driver"), trans((data['audioAdapter']['audioDriver'] == 'Null' ? 'Null Audio Driver' : data['audioAdapter']['audioDriver']))));
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Audio Controller"), trans(data['audioAdapter']['audioController'])));
	}

	if(boxes) {
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowAudio"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}		
		$(targetdiv).append(vboxDetailsTable);
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxNetwork');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	}		
	
	// Network
	vboxDetailsTable.appendChild(__vboxDetailHeader("nw_16px.png","Network",(settings ? 'Network' : null),(settings ? data : null),boxes));

	var vboxDetailsTableNics = 0;
	for(var i = 0; i < data['networkAdapters'].length; i++) {
		
		nic = data['networkAdapters'][i];
		
		// compose extra info
		var xtra = '';

		if(nic.enabled) {
			vboxDetailsTableNics++;
			switch(nic.attachmentType) {
				case 'Bridged':
				case 'HostOnly':
						xtra = ' ' + trans('adapter') + trans('LIST_SEP') + nic.hostInterface;
					break;
				case 'NAT':
						// 'NATNetwork' ?
					break;
				case 'Internal':
						xtra = ' ' + trans('network') + trans('LIST_SEP') + nic.internalNetwork;
					break;
				
			}
			if(!nic.attachmentType || nic.attachmentType == 'Null') nic.attachmentType = 'Not Attached';

			vboxDetailsTable.appendChild(__vboxDetailRow(trans("Adapter") + " " + (i + 1), trans(nic.adapterType) + ' (' + trans(nic.attachmentType) + xtra + ')'));
		}
				
	}
	
	if(vboxDetailsTableNics == 0) {
		vboxDetailsTable.appendChild(__vboxDetailRow(trans('None'),''));
		
	// Link nic to guest networking info?
	} else if(links && data['state'] == 'Running') {
		var n  = '<a href="javascript:vboxGuestNetworkAdaptersDialogInit(\''+data['id']+'\','+i+')">('+trans('Guest Network Adapters')+')</a>';
		vboxDetailsTable.appendChild(__vboxDetailRow('',n,true));
	}
		
	if(boxes) {
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowNetwork"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}		
		$(targetdiv).append(vboxDetailsTable);
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	}		

	// USB
	if(data['USBController']) {
		if(boxes) vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxUSB');
		vboxDetailsTable.appendChild(__vboxDetailHeader("usb_16px.png","USB",(settings ? 'USB' : null),(settings ? data : null),boxes));
	}
	if(data['USBController'] && data['USBController']['enabled']) {
		var tot = 0;
		var act = 0;
		for(var i = 0; i < data['USBController'].deviceFilters.length; i++) {
			tot++;
			if(data['USBController'].deviceFilters[i].active) act++;
		}
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Device Filters"), tot + ' (' + act + ' ' + trans('active') + ')'));
	} else if(data['USBController']) {
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("Disabled"),""));
	}

	if(data['USBController'] && boxes) {
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowUSB"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}		
		$(targetdiv).append(vboxDetailsTable);
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxSharedFolders');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	} else if(boxes) {
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxSharedFolders');
	}
	
	// Shared Folders
	vboxDetailsTable.appendChild(__vboxDetailHeader("shared_folder_16px.png","Shared Folders",(settings ? 'SharedFolders' : null),(settings ? data : null),boxes));
	if(!data['sharedFolders'] || data['sharedFolders'].length < 1) {
		vboxDetailsTable.appendChild(__vboxDetailRow(trans("None"), ''));
	} else {
		for(var i = 0; i < data['sharedFolders'].length; i++) {
			vboxDetailsTable.appendChild(__vboxDetailRow(data['sharedFolders'][i].name + ' (' + trans(data['sharedFolders'][i].writable ? 'rw' : 'ro') + ')', data['sharedFolders'][i].hostPath));
		}
	}

	if(boxes) {
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowSharedFolders"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));

		$(targetdiv).append(vboxDetailsTable);
		
		var vboxDetailsTable = document.createElement('table');
		vboxDetailsTable.setAttribute('id','vboxDetailsTableBoxDescription');
		vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
		if($('#vboxIndex').data('vboxCookies')["vboxSectionShowDescription"] == 0) {
			vboxDetailsTable.setAttribute('style','display: none;');
		}		
		
	}

	// Description
	vboxDetailsTable.appendChild(__vboxDetailHeader("description_16px.png","Description",(settings ? 'General:2' : null),(settings ? data : null),boxes));
	var dtr = document.createElement('tr');
	var dtd = document.createElement('td');
	$(dtd).attr('class','vboxDetailDescriptionCell');
	$(dtd).attr('colspan','2');
	$(dtd).html(data.description.length ? $('<div />').html(data.description).text() : trans("None"));
	$(dtr).append(dtd); 
	vboxDetailsTable.appendChild(dtr);

	if(boxes)
		vboxDetailsTable.appendChild(__vboxDetailRow('',''));
	
	// Append Table
	$(targetdiv).append(vboxDetailsTable);

	// Toggle show / hide
	if(boxes) {
		$(targetdiv).find('tr.vboxDetailsHead').each(function(){
			$(this).children('th').first().dblclick(function(e){
				if($(this).data('vboxHidden')) {
					$(this).removeClass('vboxDetailsSectionCollapsed');
					$(this).parent().siblings().css('display','');
					$(this).data('vboxHidden',false);
					var src = 'images/arrow_grad_up.png';
				} else {
					$(this).addClass('vboxDetailsSectionCollapsed');
					$(this).parent().siblings().css('display','none');
					$(this).data('vboxHidden',true);
					var src = 'images/arrow_grad_dn.png';				
				}
				$(this).children('span.vboxDetailsUpDnImgSpan').children('img').attr('src',src);
				e.stopPropagation();
				e.preventDefault();				
				return false;
			}).hover(function(){
				$(this).addClass('hover');},
				function(){$(this).removeClass('hover');}
			).children().children().bind('onselectstart',function(){
				return false;
			}).attr('unselectable','on').css('MozUserSelect','none');
		});
	}
}

//Display details data for VirtualBox Host
/////////////////////////////////////////////
function __vboxDisplayHostDetailsData(data) {
	

	// clear progress bar or existing data
	$('#vboxVMDetails').html('');
	
	// Details Table
	var vboxDetailsTable = document.createElement('table');
	vboxDetailsTable.setAttribute('class','vboxDetailsTable');
	vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');

	// General
	vboxDetailsTable.appendChild(__vboxDetailHeader("machine_16px.png",trans("General"),null,null,true));
	if($('#vboxIndex').data('vboxConfig').servers.length) vboxDetailsTable.appendChild(__vboxDetailRow(trans("Name"), $('#vboxIndex').data('vboxConfig').name));	
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("OS Type"), data['operatingSystem'] + ' (' + data['OSVersion'] +')'));
	vboxDetailsTable.appendChild(__vboxDetailRow("VirtualBox", $('#vboxIndex').data('vboxConfig').version.string+' ('+$('#vboxIndex').data('vboxConfig').version.revision+')'));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Base Memory"), data['memorySize'] + ' ' + trans('MB')));
	vboxDetailsTable.appendChild(__vboxDetailRow(trans("Processors"), data['cpus'][0] + ' (' + data['cpus'].length +')'));

	vboxDetailsTable.appendChild(__vboxDetailRow('',''));
	$('#vboxVMDetails').append(vboxDetailsTable);
	
	var vboxDetailsTable = document.createElement('table');
	vboxDetailsTable.setAttribute('class','vboxDetailsTable');
	vboxDetailsTable.setAttribute('class','vboxDetailsTable vboxDetailsTableBox ui-corner-all');
	
	// Network
	vboxDetailsTable.appendChild(__vboxDetailHeader("nw_16px.png",trans("Network"),null,null,true));

	for(var i = 0; i < data['networkInterfaces'].length; i++) {		
		
		vboxDetailsTable.appendChild(__vboxDetailRow(data['networkInterfaces'][i].name + ' (' + trans(data['networkInterfaces'][i].status) + ')',''));
		vboxDetailsTable.appendChild(__vboxDetailRowIndented(trans('IPv4Addr'), data['networkInterfaces'][i].IPAddress + ' / ' + data['networkInterfaces'][i].networkMask));
		if(data['networkInterfaces'][i].IPV6Supported) {
			vboxDetailsTable.appendChild(__vboxDetailRowIndented(trans('IPv6Addr'), data['networkInterfaces'][i].IPV6Address + ' / ' + data['networkInterfaces'][i].IPV6NetworkMaskPrefixLength));
		}
		vboxDetailsTable.appendChild(__vboxDetailRowIndented(trans('netMediumType'),trans(data['networkInterfaces'][i].mediumType) + (data['networkInterfaces'][i].hardwareAddress ? ' (' + data['networkInterfaces'][i].hardwareAddress + ')' : '')));
	}

	
	// Append Table
	vboxDetailsTable.appendChild(__vboxDetailRow('',''));
	$('#vboxVMDetails').append(vboxDetailsTable);
}


/* Show / Hide boxes menu */
var ul = document.createElement('ul');
ul.setAttribute('class','contextMenu');
ul.setAttribute('style','display: none');
ul.setAttribute('id','vboxDetailsShowMenu');
var sections = new Array('General','System','Preview','Display','Storage','Audio','Network','USB','Shared Folders','Description');
for(var i = 0; i < sections.length; i++) {

	// No USB in OSE
	if($('#vboxIndex').data('vboxConfig').version.ose && sections[i] == 'USB')
		continue;

	// No Preview if PHP does not have GD extensions installed / enabled
	if(!$('#vboxIndex').data('vboxConfig').imagepng && sections[i] == 'Preview')
		continue;

	// checked?
	var checked = 'checked';
	if($('#vboxIndex').data('vboxCookies')["vboxSectionShow"+sections[i].replace(' ','')] == 0)
		checked = '';
	
	var li = document.createElement('li');
	var cb = document.createElement('input');
	$(cb).attr({'type':'checkbox','class':'vboxCheckbox','name':sections[i].replace(' ','')})
	if(checked) $(cb).attr('checked',checked);
	$(cb).click(function(){

		var exp = new Date(2020,12,24);
		document.cookie = "vboxSectionShow"+$(this).attr('name')+"="+(this.checked ? 1 : 0)+"; expires="+exp.toGMTString()+"; path=/";
		$('#vboxDetailsTableBox'+$(this).attr('name')).css('display',(this.checked ? '' : 'none'));
		$('#vboxIndex').data('vboxCookies')["vboxSectionShow"+$(this).attr('name')] = (this.checked ? 1 : 0);

		// Special case for Preview
		if($(this).attr('name') == 'Preview') {
			if(this.checked && $('#vboxVMDetails').data('vmid') != 'host') {
				__vboxDrawPreview($('#vboxVMDetails').data('vmid'));
			} else {
				// Clear timer if it is set
				if($('#vboxVMDetails').data('vboxPreviewTimer')) {
					window.clearTimeout($('#vboxVMDetails').data('vboxPreviewTimer'));
					$('#vboxVMDetails').data('vboxPreviewTimer', null);
				}
			}				
		}
		
	});
	$(li).append(cb);
	var sp = document.createElement('span');
	$(sp).append(' ' + trans(sections[i]));
	$(li).append(sp);
	ul.appendChild(li);
}
$('#vboxIndex').append(ul);
$('#vboxDetailsShowMenu').bind('contextmenu', function() { return false; })

/* Preivew Update Menu */
// determine default
if($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] === undefined) {
	if($('#vboxIndex').data('vboxConfig').previewUpdateInterval)
		$('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] = $('#vboxIndex').data('vboxConfig').previewUpdateInterval;
	else
		$('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] = 3;
}
var ul = document.createElement('ul');
ul.setAttribute('class','contextMenu');
ul.setAttribute('style','display: none');
ul.setAttribute('id','vboxDetailsPreviewMenu');
$(ul).click(function(){$(this).hide();});
var radio = document.createElement('input');
$(radio).attr({'class':'vboxRadio','type':'radio','name':'vboxPreviewRadio','value':0});
$(radio).click(function(){
	$('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] = 0;
	var exp = new Date(2020,12,24);
	document.cookie = "vboxPreviewUpdate=0; expires="+exp.toGMTString()+"; path=/";
});
if($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] == 0) {
	$(radio).attr('checked','checked');
}
var li = document.createElement('li');
$(li).append(radio);
var sp = document.createElement('span');
$(sp).html(trans('Update Disabled'));
$(li).append(sp);
$(ul).append(li);
var ints = [1,3,5,10,20];
// check for update interval
if($('#vboxIndex').data('vboxConfig').previewUpdateInterval && jQuery.inArray($('#vboxIndex').data('vboxConfig').previewUpdateInterval, ints) < 0) {
	ints[ints.length] = $('#vboxIndex').data('vboxConfig').previewUpdateInterval;
}
if($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] && jQuery.inArray(parseInt($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"]), ints) < 0) {
	ints[ints.length] = $('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"];
}
ints.sort(function(a,b){
	if(a == b) return 0;
	return (a > b ? 1 : -1);
});

for(var i = 0; i < ints.length; i++) {
	var radio = document.createElement('input');
	$(radio).attr({'class':'vboxRadio','type':'radio','name':'vboxPreviewRadio','value':ints[i]});
	$(radio).click(function(){
		var exp = new Date(2020,12,24);
		document.cookie = "vboxPreviewUpdate="+$(this).val()+"; expires="+exp.toGMTString()+"; path=/";		
		$('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] = $(this).val();
		__vboxDrawPreview($('#vboxVMDetails').data('vmid'));
	});

	if($('#vboxIndex').data('vboxCookies')["vboxPreviewUpdate"] == ints[i])
		$(radio).attr('checked','checked');
	
	var li = document.createElement('li');
	if(i==0) $(li).attr('class','separator');
	$(li).append(radio);
	var sp = document.createElement('span');
	$(sp).html(trans('Every X seconds').replace('%s',ints[i]));
	$(sp).click(function(){
		$(this).siblings('input').click();
	});
	$(li).append(sp);
	$(ul).append(li);
}
$('#vboxIndex').append(ul);
$(ul).bind('contextmenu', function() { return false; })


/* Menu functionality */
$("#vboxVMDetails").mouseup( function(e) {

	if(e.button == 2) {

		// Check for right click over preview window
		var pos = $('#vboxDetailsPreviewWrap').offset();
		var w = $('#vboxDetailsPreviewWrap').outerWidth(false);
		var h = $('#vboxDetailsPreviewWrap').outerHeight(false);

		if(pos && e.pageX > 0 && e.pageX >= pos.left && e.pageX <= (pos.left + w) && e.pageY >= pos.top && e.pageY <= (pos.top+h)) {
			var menu = $('#vboxDetailsPreviewMenu');
			$('#vboxDetailsShowMenu').hide();
		} else {
			var menu = $('#vboxDetailsShowMenu');
			$('#vboxDetailsPreviewMenu').hide();
		}
		vboxPositionEvent(menu, e);
		$(menu).show();
		
		e.preventDefault();
		e.stopPropagation();

		return false;
	} else {
		$('#vboxDetailsShowMenu').hide();
		$('#vboxDetailsPreviewMenu').hide();
	}
});
$("#vboxVMDetails").bind('contextmenu', function() { return false; }).bind('click',function(e){return e.button!=2;});

</script>
</div>